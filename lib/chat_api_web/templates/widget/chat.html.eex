<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat Widget</title>
    <script src="https://cdn.jsdelivr.net/npm/phoenix@1.5.3/priv/static/phoenix.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin: 0;
            padding: 0;
        }
        
        #chat-widget-root {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Header */
        .chat-header {
            background: linear-gradient(135deg, var(--primary-color, #1677ff) 0%, #000000 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .chat-header-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4A90E2;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .chat-header-icon svg {
            width: 24px;
            height: 24px;
        }
        
        .chat-header .bot-info {
            flex: 1;
            min-width: 0;
        }
        
        .chat-header .bot-name {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-header .bot-label {
            font-size: 12px;
            opacity: 0.9;
            margin: 4px 0 0 0;
            line-height: 1.2;
        }
        
        .chat-header-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        
        .chat-header-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Messages Area */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            max-width: 80%;
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4A90E2;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .message .message-avatar svg {
            width: 18px;
            height: 18px;
        }
        
        .message.user .message-avatar {
            display: none;
        }
        
        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            color: #000;
        }
        
        .message.bot .message-bubble {
            background: #e8e8e8;
            color: #000;
            border-bottom-left-radius: 4px;
        }
        
        .message.user .message-bubble {
            background: var(--primary-color, #1677ff);
            color: white;
            border-bottom-right-radius: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        
        /* Input Area */
        .input-container {
            background: white;
            padding: 12px 16px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            border-radius: 0 0 12px 12px;
            position: relative;
        }
        
        .input-icon-button {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .input-icon-button:hover {
            background: #f5f5f5;
        }
        
        .input-wrapper {
            flex: 1;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            padding: 2px;
        }
        
        #message-input {
            width: 100%;
            padding: 10px 14px;
            border: none;
            border-radius: 18px;
            font-size: 14px;
            background: transparent;
            outline: none;
            color: #333;
        }
        
        #message-input:focus {
            background: white;
        }
        
        #message-input::placeholder {
            color: #999;
        }
        
        #send-button {
            width: 36px;
            height: 36px;
            background: #e0e0e0;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        #send-button svg {
            width: 20px;
            height: 20px;
        }
        
        #send-button:hover {
            background: #d0d0d0;
        }
        
        #send-button:active {
            transform: scale(0.95);
        }
        
        #send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #send-button.sending {
            animation: sendPulse 0.6s ease-out;
        }
        
        @keyframes sendPulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: fit-content;
            padding: 12px 16px;
            background: #f0f0f0;
            border: 1px solid #e0e0e0;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .typing-dots {
            display: flex;
            gap: 5px;
        }
        
        .typing-dot {
            width: 10px;
            height: 10px;
            background: #666;
            border-radius: 50%;
            animation: typingPulse 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingPulse {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            30% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Emoji picker */
        .emoji-picker {
            position: absolute;
            bottom: 60px;
            right: 16px;
            width: 280px;
            max-height: 300px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 12px;
            display: none;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
        }
        
        .emoji-picker.visible {
            display: flex;
        }
        
        .emoji-picker-header {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .emoji-search {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            outline: none;
            box-sizing: border-box;
        }
        
        .emoji-search:focus {
            border-color: var(--primary-color, #1677ff);
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 240px;
            padding-right: 4px;
        }
        
        .emoji-item {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        
        .emoji-item:hover {
            background: #f5f5f5;
        }
        
        .emoji-item.hidden {
            display: none;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 480px) {
            #message-input {
                font-size: 16px !important;
            }
            
            .input-icon-button,
            #send-button {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
            
            .emoji-picker {
                width: 260px;
                right: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="chat-widget-root">
        <div class="chat-header">
            <div class="chat-header-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="6" stroke="white" stroke-width="2.5" fill="none"/>
                    <line x1="12" y1="2" x2="12" y2="4" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="12" y1="20" x2="12" y2="22" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="2" y1="12" x2="4" y2="12" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="20" y1="12" x2="22" y2="12" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="5.66" y1="5.66" x2="6.88" y2="6.88" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="17.12" y1="17.12" x2="18.34" y2="18.34" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="18.34" y1="5.66" x2="17.12" y2="6.88" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    <line x1="6.88" y1="17.12" x2="5.66" y2="18.34" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="bot-info">
                <div class="bot-name" id="bot-name"></div>
                <div class="bot-label" id="bot-subtitle"></div>
            </div>
        </div>
        
        <div class="messages-container" id="messages-container">
            <!-- Messages will be added here -->
        </div>
        
        <div class="input-container">
            <div class="emoji-picker" id="emoji-picker">
                <div class="emoji-picker-header">Emojis</div>
                <input type="text" class="emoji-search" id="emoji-search" placeholder="Search emojis..." autocomplete="off" />
                <div class="emoji-grid" id="emoji-grid"></div>
            </div>
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="message-input" 
                    placeholder="Type your message..."
                    autocomplete="off"
                />
            </div>
            <button class="input-icon-button" id="emoji-button" aria-label="Add emoji">üòä</button>
            <button id="send-button" aria-label="Send message">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>
    
    <script>
        // Extract config from URL params
        const params = new URLSearchParams(window.location.search);
        const config = {
            // Core settings
            token: params.get('token') || params.get('accountId'),
            inbox: params.get('inbox'),
            baseUrl: params.get('baseUrl') || window.location.origin,
            
            // Appearance
            title: decodeURIComponent(params.get('title') || 'Chat'),
            subtitle: decodeURIComponent(params.get('subtitle') || ''),
            primaryColor: params.get('primaryColor') || '#1677ff',
            
            // Messages
            greeting: decodeURIComponent(params.get('greeting') || ''),
            newMessagePlaceholder: decodeURIComponent(params.get('newMessagePlaceholder') || 'Type your message...'),
            agentAvailableText: decodeURIComponent(params.get('agentAvailableText') || ''),
            agentUnavailableText: decodeURIComponent(params.get('agentUnavailableText') || ''),
            
            // Features
            showAgentAvailability: params.get('showAgentAvailability') === '1',
            requireEmailUpfront: params.get('requireEmailUpfront') === '1',
            isBrandingHidden: params.get('isBrandingHidden') === 'true',
            
            // Metadata
            companyName: params.get('companyName') || '',
            metadata: params.get('metadata') || '{}',
            
            // Internal state
            customerId: null,
            conversationId: null
        };

        // Set CSS variable for primary color
        document.documentElement.style.setProperty('--primary-color', config.primaryColor);
        
        // Set bot name and subtitle in header
        document.getElementById('bot-name').textContent = config.title;
        document.getElementById('bot-subtitle').textContent = config.subtitle || '';

        console.log('Chat widget initialized with config:', config);

        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');

        // Set placeholder text from config
        if (config.newMessagePlaceholder) {
            messageInput.placeholder = config.newMessagePlaceholder;
        }

        function addMessage(text, isCustomer = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isCustomer ? 'user' : 'bot'}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text;
            messageDiv.appendChild(bubble);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            // Don't show if already showing
            const existing = document.getElementById('typing-indicator');
            if (existing) {
                return;
            }
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            // Use requestAnimationFrame to prevent layout thrashing
            requestAnimationFrame(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        function hideTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) {
                typing.remove();
            }
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            // Add visual feedback animation
            const sendBtn = document.getElementById('send-button');
            if (sendBtn) {
                sendBtn.classList.add('sending');
                setTimeout(() => {
                    sendBtn.classList.remove('sending');
                }, 600);
            }

            messageInput.value = '';
            addMessage(text, true);
            
            // Don't show typing indicator manually - let backend control it via typing event
            // This prevents flicker/refresh issues

            try {
                // Create customer if needed
                if (!config.customerId) {
                    const customerResp = await fetch(`${config.baseUrl}/api/customers`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            customer: {
                                account_id: config.token,
                                inbox_id: config.inbox
                            }
                        })
                    });
                    const customerData = await customerResp.json();
                    config.customerId = customerData.data.id;
                }

                // If conversation exists, send via WebSocket
                if (config.conversationId && channel && channel.state === 'joined') {
                    channel.push('shout', {
                        body: text,
                        customer_id: config.customerId,
                        sent_at: new Date().toISOString()
                    });
                } else {
                    // Create conversation with first message
                    const convResp = await fetch(`${config.baseUrl}/api/conversations`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            conversation: {
                                account_id: config.token,
                                inbox_id: config.inbox,
                                customer_id: config.customerId,
                                status: 'open'
                            },
                            message: {
                                body: text,
                                sent_at: new Date().toISOString()
                            }
                        })
                    });
                    const convData = await convResp.json();
                    config.conversationId = convData.data.id;

                    // Connect to Phoenix channel for real-time updates
                    connectToConversation(config.conversationId);
                }

            } catch (error) {
                console.error('Error sending message:', error);
                hideTypingIndicator();
                addMessage('Sorry, there was an error sending your message. Please try again.');
            }
        }

        let socket = null;
        let channel = null;

        function connectToConversation(conversationId) {
            // Don't reconnect if already connected to the same conversation
            if (channel && channel.state === 'joined' && channel.topic === `conversation:${conversationId}`) {
                return;
            }
            
            // Clean up existing connection if different conversation
            if (channel) {
                channel.leave();
                channel = null;
            }
            if (socket) {
                socket.disconnect();
                socket = null;
            }

            const socketUrl = '/socket';
            socket = new Phoenix.Socket(socketUrl, {params: {}});
            
            socket.onOpen(() => console.log('Socket connected'));
            socket.onError(() => console.log('Socket error'));
            
            socket.connect();

            channel = socket.channel(`conversation:${conversationId}`, {
                customer_id: config.customerId
            });

            channel.on('shout', (payload) => {
                console.log('Message received:', payload);
                
                // Always hide typing indicator when receiving any message
                hideTypingIndicator();
                
                // Only process messages with a body
                if (!payload.body) {
                    return;
                }
                
                // Skip customer messages - we already display them when sending
                // Only show bot messages (type === 'bot' or no user_id) or agent messages (has user_id)
                if (payload.customer_id && payload.customer_id === config.customerId && !payload.user_id && payload.type !== 'bot') {
                    return;
                }
                
                // Determine if this is a bot message or user/agent message
                const isBotMessage = payload.type === 'bot' || !payload.user_id;
                
                // Add the message (false = bot message, true = user/agent message)
                addMessage(payload.body, !isBotMessage);
            });

            channel.on('typing', (payload) => {
                console.log('Typing event:', payload);
                if (payload.type === 'ai') {
                    // Use setTimeout to debounce rapid typing events
                    if (payload.typing) {
                        setTimeout(() => showTypingIndicator(), 50);
                    } else {
                        hideTypingIndicator();
                    }
                }
            });

            channel.join()
                .receive('ok', () => console.log('Joined conversation channel'))
                .receive('error', (err) => console.error('Failed to join:', err));
        }

        const sendButton = document.getElementById('send-button');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPicker = document.getElementById('emoji-picker');
        const emojiGrid = document.getElementById('emoji-grid');
        const emojiSearch = document.getElementById('emoji-search');
        
        // Emoji data with searchable keywords
        const emojiData = [
            {emoji: 'üòÄ', keywords: 'grinning face happy smile'},
            {emoji: 'üòÉ', keywords: 'smiling eyes happy joy'},
            {emoji: 'üòÑ', keywords: 'smiling eyes happy joy laugh'},
            {emoji: 'üòÅ', keywords: 'beaming eyes happy grin'},
            {emoji: 'üòÜ', keywords: 'squinting laugh happy'},
            {emoji: 'üòÖ', keywords: 'sweat nervous smile'},
            {emoji: 'üòÇ', keywords: 'tears joy laughing'},
            {emoji: 'ü§£', keywords: 'rolling laughing floor'},
            {emoji: 'üòä', keywords: 'smiling eyes happy'},
            {emoji: 'üòá', keywords: 'halo angel innocent'},
            {emoji: 'üôÇ', keywords: 'slight smile'},
            {emoji: 'üôÉ', keywords: 'upside down'},
            {emoji: 'üòâ', keywords: 'wink'},
            {emoji: 'üòå', keywords: 'relieved calm'},
            {emoji: 'üòç', keywords: 'heart eyes love'},
            {emoji: 'ü•∞', keywords: 'smiling hearts love'},
            {emoji: 'üòò', keywords: 'kiss blowing'},
            {emoji: 'üòó', keywords: 'kissing'},
            {emoji: 'üòô', keywords: 'kissing smiling eyes'},
            {emoji: 'üòö', keywords: 'kissing closed eyes'},
            {emoji: 'üòã', keywords: 'savoring food yummy'},
            {emoji: 'üòõ', keywords: 'tongue playful'},
            {emoji: 'üòù', keywords: 'squinting tongue'},
            {emoji: 'üòú', keywords: 'wink tongue'},
            {emoji: 'ü§™', keywords: 'zany crazy'},
            {emoji: 'ü§®', keywords: 'raised eyebrow suspicious'},
            {emoji: 'üßê', keywords: 'monocle detective'},
            {emoji: 'ü§ì', keywords: 'nerd glasses'},
            {emoji: 'üòé', keywords: 'sunglasses cool'},
            {emoji: 'ü§©', keywords: 'star eyes'},
            {emoji: 'ü•≥', keywords: 'party celebration'},
            {emoji: 'üòè', keywords: 'smirk'},
            {emoji: 'üòí', keywords: 'unamused'},
            {emoji: 'üòû', keywords: 'disappointed sad'},
            {emoji: 'üòî', keywords: 'pensive sad'},
            {emoji: 'üòü', keywords: 'worried'},
            {emoji: 'üòï', keywords: 'confused'},
            {emoji: 'üôÅ', keywords: 'slight frown'},
            {emoji: '‚òπÔ∏è', keywords: 'frown sad'},
            {emoji: 'üò£', keywords: 'persevere'},
            {emoji: 'üòñ', keywords: 'confounded'},
            {emoji: 'üò´', keywords: 'tired weary'},
            {emoji: 'üò©', keywords: 'weary tired'},
            {emoji: 'ü•∫', keywords: 'pleading puppy'},
            {emoji: 'üò¢', keywords: 'cry tears sad'},
            {emoji: 'üò≠', keywords: 'loudly crying tears'},
            {emoji: 'üò§', keywords: 'triumph huff'},
            {emoji: 'üò†', keywords: 'angry mad'},
            {emoji: 'üò°', keywords: 'pouting angry'},
            {emoji: 'ü§¨', keywords: 'swearing cursing'},
            {emoji: 'ü§Ø', keywords: 'exploding mind'},
            {emoji: 'üò≥', keywords: 'flushed embarrassed'},
            {emoji: 'ü•µ', keywords: 'hot fever'},
            {emoji: 'ü•∂', keywords: 'cold freezing'},
            {emoji: 'üò±', keywords: 'scream fear'},
            {emoji: 'üò®', keywords: 'fearful scared'},
            {emoji: 'üò∞', keywords: 'anxious sweat'},
            {emoji: 'üò•', keywords: 'sad relieved'},
            {emoji: 'üòì', keywords: 'sweat nervous'},
            {emoji: 'ü§ó', keywords: 'hugging'},
            {emoji: 'ü§î', keywords: 'thinking'},
            {emoji: 'ü§≠', keywords: 'hand over mouth'},
            {emoji: 'ü§´', keywords: 'shushing quiet'},
            {emoji: 'ü§•', keywords: 'lying pinocchio'},
            {emoji: 'üò∂', keywords: 'no mouth'},
            {emoji: 'üòê', keywords: 'neutral'},
            {emoji: 'üòë', keywords: 'expressionless'},
            {emoji: 'üò¨', keywords: 'grimacing'},
            {emoji: 'üôÑ', keywords: 'rolling eyes'},
            {emoji: 'üòØ', keywords: 'hushed surprised'},
            {emoji: 'üò¶', keywords: 'frown open mouth'},
            {emoji: 'üòß', keywords: 'anguished'},
            {emoji: 'üòÆ', keywords: 'open mouth'},
            {emoji: 'üò≤', keywords: 'astonished surprised'},
            {emoji: 'ü•±', keywords: 'yawning tired'},
            {emoji: 'üò¥', keywords: 'sleeping zzz'},
            {emoji: 'ü§§', keywords: 'drooling'},
            {emoji: 'üò™', keywords: 'sleepy tired'},
            {emoji: 'üòµ', keywords: 'dizzy'},
            {emoji: 'ü§ê', keywords: 'zipper mouth'},
            {emoji: 'üëç', keywords: 'thumbs up like'},
            {emoji: 'üëé', keywords: 'thumbs down dislike'},
            {emoji: 'üëå', keywords: 'ok hand'},
            {emoji: '‚úåÔ∏è', keywords: 'peace victory'},
            {emoji: 'ü§û', keywords: 'crossed fingers luck'},
            {emoji: 'ü§ü', keywords: 'love you rock'},
            {emoji: 'ü§ò', keywords: 'rock horns metal'},
            {emoji: 'ü§ô', keywords: 'call me phone'},
            {emoji: 'üëè', keywords: 'clapping applause'},
            {emoji: 'üôå', keywords: 'raising hands celebration'},
            {emoji: 'üëê', keywords: 'open hands'},
            {emoji: 'ü§≤', keywords: 'palms up together'},
            {emoji: 'ü§ù', keywords: 'handshake deal'},
            {emoji: 'üôè', keywords: 'praying please'},
            {emoji: '‚úçÔ∏è', keywords: 'writing hand'},
            {emoji: 'üí™', keywords: 'muscle flex strong'},
            {emoji: '‚ù§Ô∏è', keywords: 'red heart love'},
            {emoji: 'üß°', keywords: 'orange heart'},
            {emoji: 'üíõ', keywords: 'yellow heart'},
            {emoji: 'üíö', keywords: 'green heart'},
            {emoji: 'üíô', keywords: 'blue heart'},
            {emoji: 'üíú', keywords: 'purple heart'},
            {emoji: 'üñ§', keywords: 'black heart'},
            {emoji: 'ü§ç', keywords: 'white heart'},
            {emoji: 'üíî', keywords: 'broken heart'},
            {emoji: '‚ù£Ô∏è', keywords: 'heart exclamation'},
            {emoji: 'üíï', keywords: 'two hearts love'},
            {emoji: 'üíû', keywords: 'revolving hearts'},
            {emoji: 'üíì', keywords: 'beating heart'},
            {emoji: 'üíó', keywords: 'growing heart'},
            {emoji: 'üíñ', keywords: 'sparkling heart'},
            {emoji: 'üíò', keywords: 'cupid arrow love'},
            {emoji: 'üíù', keywords: 'gift heart'},
            {emoji: 'üíü', keywords: 'heart decoration'},
            {emoji: '‚òÆÔ∏è', keywords: 'peace symbol'},
            {emoji: '‚úùÔ∏è', keywords: 'cross christian'},
            {emoji: '‚ò™Ô∏è', keywords: 'star crescent islam'},
            {emoji: 'üïâ', keywords: 'om hindu'},
            {emoji: '‚ò∏Ô∏è', keywords: 'wheel dharma buddhist'},
            {emoji: '‚ú°Ô∏è', keywords: 'star david jewish'},
            {emoji: 'üîØ', keywords: 'dotted six pointed star'},
            {emoji: 'üïé', keywords: 'menorah candelabra'},
            {emoji: '‚òØÔ∏è', keywords: 'yin yang tao'},
            {emoji: '‚ò¶Ô∏è', keywords: 'orthodox cross'},
            {emoji: 'üõê', keywords: 'place worship'},
            {emoji: '‚õé', keywords: 'ophiuchus'},
            {emoji: '‚ôà', keywords: 'aries ram'},
            {emoji: '‚ôâ', keywords: 'taurus bull'},
            {emoji: '‚ôä', keywords: 'gemini twins'},
            {emoji: '‚ôã', keywords: 'cancer crab'},
            {emoji: '‚ôå', keywords: 'leo lion'},
            {emoji: '‚ôç', keywords: 'virgo'},
            {emoji: '‚ôé', keywords: 'libra scales'},
            {emoji: '‚ôè', keywords: 'scorpio scorpion'},
            {emoji: '‚ôê', keywords: 'sagittarius archer'},
            {emoji: '‚ôë', keywords: 'capricorn goat'},
            {emoji: '‚ôí', keywords: 'aquarius water'},
            {emoji: '‚ôì', keywords: 'pisces fish'},
            {emoji: 'üÜî', keywords: 'id identity'},
            {emoji: '‚öõÔ∏è', keywords: 'atom symbol'},
            {emoji: 'üâë', keywords: 'acceptable'},
            {emoji: '‚ò¢Ô∏è', keywords: 'radioactive'},
            {emoji: '‚ò£Ô∏è', keywords: 'biohazard'},
            {emoji: 'üì¥', keywords: 'mobile phone off'},
            {emoji: 'üì≥', keywords: 'vibration mode'},
            {emoji: 'üà∂', keywords: 'japanese not free charge'},
            {emoji: 'üàö', keywords: 'japanese free charge'},
            {emoji: 'üà∏', keywords: 'japanese application'},
            {emoji: 'üà∫', keywords: 'japanese open business'},
            {emoji: 'üà∑Ô∏è', keywords: 'japanese monthly amount'},
            {emoji: '‚ú¥Ô∏è', keywords: 'eight pointed star'},
            {emoji: 'üÜö', keywords: 'versus vs'},
            {emoji: 'üíÆ', keywords: 'white flower'},
            {emoji: 'üâê', keywords: 'japanese bargain'},
            {emoji: '„äôÔ∏è', keywords: 'japanese secret'},
            {emoji: '„äóÔ∏è', keywords: 'japanese congratulations'},
            {emoji: 'üà¥', keywords: 'japanese passing grade'},
            {emoji: 'üàµ', keywords: 'japanese no vacancy'},
            {emoji: 'üàπ', keywords: 'japanese discount'},
            {emoji: 'üà≤', keywords: 'japanese prohibited'},
            {emoji: 'üÖ∞Ô∏è', keywords: 'a button'},
            {emoji: 'üÖ±Ô∏è', keywords: 'b button'},
            {emoji: 'üÜé', keywords: 'ab button'},
            {emoji: 'üÜë', keywords: 'cl button'},
            {emoji: 'üÖæÔ∏è', keywords: 'o button'},
            {emoji: 'üÜò', keywords: 'sos help'},
            {emoji: '‚ùå', keywords: 'cross mark wrong'},
            {emoji: '‚≠ï', keywords: 'heavy large circle'},
            {emoji: 'üõë', keywords: 'stop sign'},
            {emoji: '‚õî', keywords: 'no entry'},
            {emoji: 'üìõ', keywords: 'name badge'},
            {emoji: 'üö´', keywords: 'prohibited forbidden'},
            {emoji: 'üíØ', keywords: 'hundred points perfect'},
            {emoji: 'üí¢', keywords: 'anger symbol'},
            {emoji: '‚ô®Ô∏è', keywords: 'hot springs'},
            {emoji: 'üö∑', keywords: 'no pedestrians'},
            {emoji: 'üöØ', keywords: 'no littering'},
            {emoji: 'üö≥', keywords: 'no bicycles'},
            {emoji: 'üö±', keywords: 'non potable water'},
            {emoji: 'üîû', keywords: 'no one under eighteen'},
            {emoji: 'üìµ', keywords: 'no mobile phones'},
            {emoji: 'üö≠', keywords: 'no smoking'},
            {emoji: '‚ùó', keywords: 'exclamation mark'},
            {emoji: '‚ùï', keywords: 'white exclamation mark'},
            {emoji: '‚ùì', keywords: 'question mark'},
            {emoji: '‚ùî', keywords: 'white question mark'},
            {emoji: '‚ÄºÔ∏è', keywords: 'double exclamation'},
            {emoji: '‚ÅâÔ∏è', keywords: 'exclamation question'},
            {emoji: 'üîÖ', keywords: 'low brightness dim'},
            {emoji: 'üîÜ', keywords: 'high brightness bright'},
            {emoji: '„ÄΩÔ∏è', keywords: 'part alternation mark'},
            {emoji: '‚ö†Ô∏è', keywords: 'warning caution'},
            {emoji: 'üö∏', keywords: 'children crossing'},
            {emoji: 'üî±', keywords: 'trident emblem'},
            {emoji: '‚öúÔ∏è', keywords: 'fleur de lis'},
            {emoji: 'üî∞', keywords: 'japanese symbol beginner'},
            {emoji: '‚ôªÔ∏è', keywords: 'recycling'},
            {emoji: '‚úÖ', keywords: 'check mark button'},
            {emoji: 'üàØ', keywords: 'japanese reserved'},
            {emoji: 'üíπ', keywords: 'chart increasing yen'},
            {emoji: '‚ùáÔ∏è', keywords: 'sparkle'},
            {emoji: '‚ú≥Ô∏è', keywords: 'eight spoked asterisk'},
            {emoji: '‚ùé', keywords: 'cross mark button'},
            {emoji: 'üåê', keywords: 'globe meridians world'},
            {emoji: 'üí†', keywords: 'diamond shape dot'},
            {emoji: '‚ìÇÔ∏è', keywords: 'circled m'},
            {emoji: 'üåÄ', keywords: 'cyclone hurricane'},
            {emoji: 'üí§', keywords: 'zzz sleep'},
            {emoji: 'üèß', keywords: 'atm sign'},
            {emoji: 'üöæ', keywords: 'water closet toilet'},
            {emoji: '‚ôø', keywords: 'wheelchair symbol'},
            {emoji: 'üÖøÔ∏è', keywords: 'p button parking'},
            {emoji: 'üà≥', keywords: 'japanese vacancy'},
            {emoji: 'üàÇÔ∏è', keywords: 'japanese service charge'},
            {emoji: 'üõÇ', keywords: 'passport control'},
            {emoji: 'üõÉ', keywords: 'customs'},
            {emoji: 'üõÑ', keywords: 'baggage claim'},
            {emoji: 'üõÖ', keywords: 'left luggage'},
            {emoji: 'üöπ', keywords: 'mens room'},
            {emoji: 'üö∫', keywords: 'womens room'},
            {emoji: 'üöº', keywords: 'baby symbol'},
            {emoji: 'üöª', keywords: 'restroom'},
            {emoji: 'üöÆ', keywords: 'litter bin'},
            {emoji: 'üé¶', keywords: 'cinema movie'},
            {emoji: 'üì∂', keywords: 'antenna bars signal'},
            {emoji: 'üàÅ', keywords: 'japanese here'},
            {emoji: 'üî£', keywords: 'input symbols'},
            {emoji: '‚ÑπÔ∏è', keywords: 'information'},
            {emoji: 'üî§', keywords: 'input latin letters'},
            {emoji: 'üî°', keywords: 'input latin lowercase'},
            {emoji: 'üî†', keywords: 'input latin uppercase'},
            {emoji: 'üÜñ', keywords: 'ng button'},
            {emoji: 'üÜó', keywords: 'ok button'},
            {emoji: 'üÜô', keywords: 'up button'},
            {emoji: 'üÜí', keywords: 'cool button'},
            {emoji: 'üÜï', keywords: 'new button'},
            {emoji: 'üÜì', keywords: 'free button'},
            {emoji: '0Ô∏è‚É£', keywords: 'zero'},
            {emoji: '1Ô∏è‚É£', keywords: 'one'},
            {emoji: '2Ô∏è‚É£', keywords: 'two'},
            {emoji: '3Ô∏è‚É£', keywords: 'three'},
            {emoji: '4Ô∏è‚É£', keywords: 'four'},
            {emoji: '5Ô∏è‚É£', keywords: 'five'},
            {emoji: '6Ô∏è‚É£', keywords: 'six'},
            {emoji: '7Ô∏è‚É£', keywords: 'seven'},
            {emoji: '8Ô∏è‚É£', keywords: 'eight'},
            {emoji: '9Ô∏è‚É£', keywords: 'nine'},
            {emoji: 'üîü', keywords: 'keycap ten'},
            {emoji: 'üî¢', keywords: 'input numbers'},
            {emoji: '#Ô∏è‚É£', keywords: 'hash number'},
            {emoji: '*Ô∏è‚É£', keywords: 'asterisk'},
            {emoji: '‚ñ∂Ô∏è', keywords: 'play button'},
            {emoji: '‚è∏', keywords: 'pause button'},
            {emoji: '‚èØ', keywords: 'play pause'},
            {emoji: '‚èπ', keywords: 'stop button'},
            {emoji: '‚è∫', keywords: 'record button'},
            {emoji: '‚è≠', keywords: 'next track'},
            {emoji: '‚èÆ', keywords: 'last track'},
            {emoji: '‚è©', keywords: 'fast forward'},
            {emoji: '‚è™', keywords: 'fast reverse'},
            {emoji: '‚è´', keywords: 'fast up button'},
            {emoji: '‚è¨', keywords: 'fast down button'},
            {emoji: '‚óÄÔ∏è', keywords: 'reverse button'},
            {emoji: 'üîº', keywords: 'up button'},
            {emoji: 'üîΩ', keywords: 'down button'},
            {emoji: '‚û°Ô∏è', keywords: 'right arrow'},
            {emoji: '‚¨ÖÔ∏è', keywords: 'left arrow'},
            {emoji: '‚¨ÜÔ∏è', keywords: 'up arrow'},
            {emoji: '‚¨áÔ∏è', keywords: 'down arrow'},
            {emoji: '‚ÜóÔ∏è', keywords: 'up right arrow'},
            {emoji: '‚ÜñÔ∏è', keywords: 'up left arrow'},
            {emoji: '‚ÜòÔ∏è', keywords: 'down right arrow'},
            {emoji: '‚ÜôÔ∏è', keywords: 'down left arrow'},
            {emoji: '‚ÜîÔ∏è', keywords: 'left right arrow'},
            {emoji: '‚ÜïÔ∏è', keywords: 'up down arrow'},
            {emoji: 'üîÑ', keywords: 'counterclockwise arrows'},
            {emoji: '‚Ü™Ô∏è', keywords: 'right arrow curving left'},
            {emoji: '‚§¥Ô∏è', keywords: 'right arrow curving up'},
            {emoji: '‚§µÔ∏è', keywords: 'right arrow curving down'},
            {emoji: 'üîÄ', keywords: 'shuffle tracks'},
            {emoji: 'üîÅ', keywords: 'repeat button'},
            {emoji: 'üîÇ', keywords: 'repeat single button'},
            {emoji: 'üîÉ', keywords: 'clockwise arrows'},
            {emoji: 'üéµ', keywords: 'musical note'},
            {emoji: 'üé∂', keywords: 'musical notes'},
            {emoji: '‚ûï', keywords: 'plus add'},
            {emoji: '‚ûñ', keywords: 'minus subtract'},
            {emoji: '‚ûó', keywords: 'divide'},
            {emoji: '‚úñÔ∏è', keywords: 'multiply times'},
            {emoji: 'üí≤', keywords: 'heavy dollar sign'},
            {emoji: 'üí±', keywords: 'currency exchange'},
            {emoji: '‚Ñ¢Ô∏è', keywords: 'trade mark'},
            {emoji: '¬©Ô∏è', keywords: 'copyright'},
            {emoji: '¬ÆÔ∏è', keywords: 'registered'},
            {emoji: '„Ä∞Ô∏è', keywords: 'wavy dash'},
            {emoji: '‚û∞', keywords: 'curly loop'},
            {emoji: '‚ûø', keywords: 'double curly loop'},
            {emoji: 'üîö', keywords: 'end arrow'},
            {emoji: 'üîô', keywords: 'back arrow'},
            {emoji: 'üîõ', keywords: 'on arrow'},
            {emoji: 'üîú', keywords: 'soon arrow'},
            {emoji: 'üîù', keywords: 'top arrow'},
            {emoji: '‚úîÔ∏è', keywords: 'check mark'},
            {emoji: '‚òëÔ∏è', keywords: 'check box'},
            {emoji: 'üîò', keywords: 'radio button'},
            {emoji: '‚ö™', keywords: 'white circle'},
            {emoji: '‚ö´', keywords: 'black circle'},
            {emoji: 'üî¥', keywords: 'red circle'},
            {emoji: 'üîµ', keywords: 'blue circle'},
            {emoji: 'üî∫', keywords: 'red triangle up'},
            {emoji: 'üîª', keywords: 'red triangle down'},
            {emoji: 'üî∏', keywords: 'small orange diamond'},
            {emoji: 'üîπ', keywords: 'small blue diamond'},
            {emoji: 'üî∂', keywords: 'large orange diamond'},
            {emoji: 'üî∑', keywords: 'large blue diamond'},
            {emoji: 'üî≥', keywords: 'white square button'},
            {emoji: 'üî≤', keywords: 'black square button'},
            {emoji: '‚ñ™Ô∏è', keywords: 'black small square'},
            {emoji: '‚ñ´Ô∏è', keywords: 'white small square'},
            {emoji: '‚óæ', keywords: 'black medium small square'},
            {emoji: '‚óΩ', keywords: 'white medium small square'},
            {emoji: '‚óºÔ∏è', keywords: 'black medium square'},
            {emoji: '‚óªÔ∏è', keywords: 'white medium square'},
            {emoji: 'üü•', keywords: 'red square'},
            {emoji: 'üüß', keywords: 'orange square'},
            {emoji: 'üü®', keywords: 'yellow square'},
            {emoji: 'üü©', keywords: 'green square'},
            {emoji: 'üü¶', keywords: 'blue square'},
            {emoji: 'üü™', keywords: 'purple square'},
            {emoji: 'üü´', keywords: 'brown square'},
            {emoji: '‚¨õ', keywords: 'black large square'},
            {emoji: '‚¨ú', keywords: 'white large square'},
            {emoji: 'üîà', keywords: 'speaker low volume'},
            {emoji: 'üîá', keywords: 'muted speaker'},
            {emoji: 'üîâ', keywords: 'speaker medium volume'},
            {emoji: 'üîä', keywords: 'speaker high volume'},
            {emoji: 'üîî', keywords: 'bell notification'},
            {emoji: 'üîï', keywords: 'bell with slash'},
            {emoji: 'üì£', keywords: 'megaphone'},
            {emoji: 'üì¢', keywords: 'loudspeaker'},
            {emoji: 'üëÅ‚Äçüó®', keywords: 'eye speech bubble'},
            {emoji: 'üí¨', keywords: 'speech balloon'},
            {emoji: 'üí≠', keywords: 'thought balloon'},
            {emoji: 'üóØ', keywords: 'right anger bubble'},
            {emoji: '‚ô†Ô∏è', keywords: 'spade suit card'},
            {emoji: '‚ô£Ô∏è', keywords: 'club suit card'},
            {emoji: '‚ô•Ô∏è', keywords: 'heart suit card'},
            {emoji: '‚ô¶Ô∏è', keywords: 'diamond suit card'},
            {emoji: 'üÉè', keywords: 'joker card'},
            {emoji: 'üé¥', keywords: 'flower playing cards'},
            {emoji: 'üÄÑ', keywords: 'mahjong red dragon'},
            {emoji: 'üïê', keywords: 'one oclock'},
            {emoji: 'üïë', keywords: 'two oclock'},
            {emoji: 'üïí', keywords: 'three oclock'},
            {emoji: 'üïì', keywords: 'four oclock'},
            {emoji: 'üïî', keywords: 'five oclock'},
            {emoji: 'üïï', keywords: 'six oclock'},
            {emoji: 'üïñ', keywords: 'seven oclock'},
            {emoji: 'üïó', keywords: 'eight oclock'},
            {emoji: 'üïò', keywords: 'nine oclock'},
            {emoji: 'üïô', keywords: 'ten oclock'},
            {emoji: 'üïö', keywords: 'eleven oclock'},
            {emoji: 'üïõ', keywords: 'twelve oclock'},
            {emoji: 'üïú', keywords: 'one thirty'},
            {emoji: 'üïù', keywords: 'two thirty'},
            {emoji: 'üïû', keywords: 'three thirty'},
            {emoji: 'üïü', keywords: 'four thirty'},
            {emoji: 'üï†', keywords: 'five thirty'},
            {emoji: 'üï°', keywords: 'six thirty'},
            {emoji: 'üï¢', keywords: 'seven thirty'},
            {emoji: 'üï£', keywords: 'eight thirty'},
            {emoji: 'üï§', keywords: 'nine thirty'},
            {emoji: 'üï•', keywords: 'ten thirty'},
            {emoji: 'üï¶', keywords: 'eleven thirty'},
            {emoji: 'üïß', keywords: 'twelve thirty'}
        ];
        
        // Populate emoji grid
        emojiData.forEach(data => {
            const emojiItem = document.createElement('div');
            emojiItem.className = 'emoji-item';
            emojiItem.textContent = data.emoji;
            emojiItem.dataset.keywords = data.keywords;
            emojiItem.addEventListener('click', () => {
                const cursorPos = messageInput.selectionStart || messageInput.value.length;
                const textBefore = messageInput.value.substring(0, cursorPos);
                const textAfter = messageInput.value.substring(cursorPos);
                messageInput.value = textBefore + data.emoji + textAfter;
                messageInput.focus();
                messageInput.setSelectionRange(cursorPos + data.emoji.length, cursorPos + data.emoji.length);
                emojiPicker.classList.remove('visible');
                emojiSearch.value = '';
                filterEmojis('');
            });
            emojiGrid.appendChild(emojiItem);
        });
        
        // Filter emojis based on search
        function filterEmojis(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            const items = emojiGrid.querySelectorAll('.emoji-item');
            
            items.forEach(item => {
                const keywords = item.dataset.keywords || '';
                if (term === '' || keywords.includes(term)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }
        
        // Search input handler
        emojiSearch.addEventListener('input', (e) => {
            filterEmojis(e.target.value);
        });
        
        // Prevent search input from closing picker
        emojiSearch.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // Toggle emoji picker
        emojiButton.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.classList.toggle('visible');
        });
        
        // Close emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
                emojiPicker.classList.remove('visible');
            }
        });
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        sendButton.addEventListener('click', () => {
            sendMessage();
        });

        // Ensure typing indicator is hidden on initial load
        hideTypingIndicator();
        
        // Show greeting
        if (config.greeting) {
            setTimeout(() => {
                addMessage(config.greeting);
            }, 500);
        }
        
        // Show availability status if enabled
        if (config.showAgentAvailability) {
            const availabilityText = config.agentAvailableText || 'We\'re online and ready to help!';
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'text-align: center; padding: 8px; color: #666; font-size: 12px;';
            statusDiv.innerHTML = `<span style="color: #52c41a;">‚óè</span> ${availabilityText}`;
            messagesContainer.insertBefore(statusDiv, messagesContainer.firstChild);
        }
    </script>
</body>
</html>
